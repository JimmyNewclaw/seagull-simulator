<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Seagull Simulator</title>
  <style>
    :root {
      --sand: #f8d777;
      --sea: #63c6ff;
      --ui: #0f1f38;
      --card: #ffffffee;
      --accent: #ff9f1c;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(180deg, var(--sea) 0%, #8ad8ff 24%, var(--sand) 24%, #f2c96a 100%);
      color: #12233f;
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 10px;
      touch-action: manipulation;
    }
    .wrap {
      width: min(96vw, 980px);
      display: grid;
      gap: 10px;
    }
    .hud {
      background: var(--card);
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 800;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 6px;
      box-shadow: 0 8px 20px rgba(0,0,0,.12);
    }
    #game {
      width: 100%;
      aspect-ratio: 16/9;
      background: #f7d57d;
      border-radius: 14px;
      border: 3px solid #ffffffaa;
      box-shadow: 0 10px 24px rgba(0,0,0,.18);
      display: block;
      touch-action: none;
    }
    .controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .btn {
      border: none;
      border-radius: 12px;
      padding: 12px;
      font-size: 1rem;
      font-weight: 900;
      color: #12233f;
      background: #fff;
      box-shadow: 0 6px 16px rgba(0,0,0,.15);
    }
    .btn:active { transform: translateY(1px); }
    #screamBtn { background: #ffe16b; }
    #grabBtn { background: #9cffb0; }
    .cool {
      height: 10px;
      width: 100%;
      background: #ffffffaa;
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid #00000020;
    }
    #coolFill {
      height: 100%;
      width: 100%;
      background: linear-gradient(90deg, #ff6666, #ffd166);
      transition: width .06s linear;
    }
    .meta {
      display: grid;
      gap: 8px;
      grid-template-columns: 1fr;
      background: var(--card);
      border-radius: 12px;
      padding: 10px;
      box-shadow: 0 8px 20px rgba(0,0,0,.12);
      font-size: .95rem;
    }
    #overlay {
      position: fixed;
      inset: 0;
      display: grid;
      place-items: center;
      background: rgba(9,17,30,.55);
      z-index: 10;
    }
    #panel {
      width: min(90vw, 560px);
      background: #ffffff;
      border-radius: 16px;
      padding: 18px;
      text-align: center;
      box-shadow: 0 14px 28px rgba(0,0,0,.25);
    }
    #panel h1 { margin: 0 0 10px; }
    #panel .small { color: #42557f; }
    #playAgain {
      margin-top: 10px;
      border: none;
      background: #ffcf3c;
      border-radius: 12px;
      padding: 11px 14px;
      font-weight: 900;
      cursor: pointer;
    }
    .hidden { display: none !important; }
    @media (min-width: 760px) {
      .meta { grid-template-columns: 1fr 1fr; }
      .controls { grid-template-columns: 180px 180px; justify-content: start; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hud">
      <div id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
      <div id="score">Score: 0</div>
      <div id="level">Level: 1 ‚Äî Beach Blankets</div>
      <div id="timer">‚è± 60</div>
    </div>

    <canvas id="game" width="960" height="540"></canvas>

    <div class="controls">
      <button id="screamBtn" class="btn">SCREAM üîä</button>
      <button id="grabBtn" class="btn">Grab ü¶Ä</button>
    </div>

    <div class="cool"><div id="coolFill"></div></div>

    <div class="meta">
      <div id="statusText">MINE! MINE! MINE!</div>
      <div id="lbText">Leaderboard loading...</div>
    </div>
  </div>

  <div id="overlay">
    <div id="panel">
      <h1>üê¶ Seagull Simulator</h1>
      <p class="small">Steal food. Dodge humans. Scream chaos.</p>
      <p class="small">WASD/Arrows to move ‚Ä¢ Space = Scream ‚Ä¢ E = Grab</p>
      <button id="playAgain">Start Terrorizing</button>
    </div>
  </div>

  <script>
    const cvs = document.getElementById('game');
    const ctx = cvs.getContext('2d');

    const uiLives = document.getElementById('lives');
    const uiScore = document.getElementById('score');
    const uiLevel = document.getElementById('level');
    const uiTimer = document.getElementById('timer');
    const uiStatus = document.getElementById('statusText');
    const uiLB = document.getElementById('lbText');
    const coolFill = document.getElementById('coolFill');

    const overlay = document.getElementById('overlay');
    const panel = document.getElementById('panel');
    const playAgainBtn = document.getElementById('playAgain');

    const screamBtn = document.getElementById('screamBtn');
    const grabBtn = document.getElementById('grabBtn');

    const W = cvs.width;
    const H = cvs.height;

    const levels = [
      { name: 'Beach Blankets', threshold: 240, humanMult: 1, foodMult: 1 },
      { name: 'Boardwalk', threshold: 420, humanMult: 1.25, foodMult: 1.2 },
      { name: 'Outdoor Restaurant Patio', threshold: 650, humanMult: 1.55, foodMult: 1.4 }
    ];

    const foodsBase = [
      { kind: 'fries', value: 10, color: '#ffd166' },
      { kind: 'hotdog', value: 25, color: '#d97706' },
      { kind: 'icecream', value: 50, color: '#fde68a' },
      { kind: 'pizza', value: 100, color: '#fb7185' }
    ];

    const state = {
      running: false,
      level: 0,
      score: 0,
      lives: 3,
      timer: 60,
      screamCd: 0,
      invuln: 0,
      shake: 0,
      seagull: { x: W * 0.22, y: H * 0.52, r: 15, speed: 220, vx: 0, vy: 0 },
      foods: [],
      blankets: [],
      humans: [],
      projectiles: [],
      floating: [],
      keys: {},
      pointer: null,
      audioCtx: null,
      leaderboard: []
    };

    function rand(min, max) { return min + Math.random() * (max - min); }
    function pick(arr) { return arr[(Math.random() * arr.length) | 0]; }

    function setStatus(t) { uiStatus.textContent = t; }

    function sound(type) {
      const AC = window.AudioContext || window.webkitAudioContext;
      if (!AC) return;
      if (!state.audioCtx) state.audioCtx = new AC();
      const ac = state.audioCtx;
      if (ac.state === 'suspended') ac.resume();

      const o = ac.createOscillator();
      const g = ac.createGain();
      o.connect(g); g.connect(ac.destination);

      const t0 = ac.currentTime;
      if (type === 'flap') {
        o.type = 'triangle';
        o.frequency.setValueAtTime(920, t0);
        g.gain.setValueAtTime(0.001, t0);
        g.gain.exponentialRampToValueAtTime(0.05, t0 + 0.008);
        g.gain.exponentialRampToValueAtTime(0.001, t0 + 0.05);
        o.start(t0); o.stop(t0 + 0.06);
      } else if (type === 'grab') {
        o.type = 'sine';
        o.frequency.setValueAtTime(520, t0);
        o.frequency.exponentialRampToValueAtTime(740, t0 + 0.05);
        g.gain.setValueAtTime(0.001, t0);
        g.gain.exponentialRampToValueAtTime(0.06, t0 + 0.01);
        g.gain.exponentialRampToValueAtTime(0.001, t0 + 0.09);
        o.start(t0); o.stop(t0 + 0.1);
      } else if (type === 'hit') {
        o.type = 'square';
        o.frequency.setValueAtTime(280, t0);
        o.frequency.exponentialRampToValueAtTime(130, t0 + 0.24);
        g.gain.setValueAtTime(0.001, t0);
        g.gain.exponentialRampToValueAtTime(0.08, t0 + 0.02);
        g.gain.exponentialRampToValueAtTime(0.001, t0 + 0.3);
        o.start(t0); o.stop(t0 + 0.31);
      } else if (type === 'milestone') {
        [['sine', 520, 0], ['triangle', 650, 0.03], ['sine', 780, 0.05]].forEach(([ty, hz, delay]) => {
          const oo = ac.createOscillator();
          const gg = ac.createGain();
          oo.type = ty;
          oo.frequency.setValueAtTime(hz, t0 + delay);
          gg.gain.setValueAtTime(0.001, t0 + delay);
          gg.gain.exponentialRampToValueAtTime(0.06, t0 + delay + 0.01);
          gg.gain.exponentialRampToValueAtTime(0.001, t0 + delay + 0.14);
          oo.connect(gg); gg.connect(ac.destination);
          oo.start(t0 + delay); oo.stop(t0 + delay + 0.16);
        });
      }
    }

    async function storageGet(key) {
      try {
        if (window.storage?.get) return await window.storage.get(key);
      } catch {}
      return localStorage.getItem(key);
    }
    async function storageSet(key, value, shared = false) {
      try {
        if (window.storage?.set) return await window.storage.set(key, value, shared);
      } catch {}
      localStorage.setItem(key, value);
    }

    async function loadLeaderboard() {
      const raw = await storageGet('seagull:leaderboard');
      state.leaderboard = raw ? JSON.parse(raw) : [];
      renderLeaderboardText();
    }

    function renderLeaderboardText() {
      if (!state.leaderboard.length) {
        uiLB.textContent = 'Global leaderboard: nobody has stolen lunch yet.';
        return;
      }
      const top = state.leaderboard.slice(0, 3).map((s, i) => `#${i + 1} ${s.name} (${s.score})`).join(' ‚Ä¢ ');
      uiLB.textContent = `Global leaderboard: ${top}`;
    }

    function createLevel() {
      state.blankets = [];
      state.foods = [];
      state.humans = [];
      state.projectiles = [];

      const lvl = levels[state.level];
      const blanketsN = 8 + state.level * 2;
      for (let i = 0; i < blanketsN; i++) {
        const b = { x: rand(90, W - 150), y: rand(80, H - 110), w: rand(80, 130), h: rand(60, 90), color: `hsl(${rand(0, 360)},70%,${rand(60,78)}%)` };
        state.blankets.push(b);

        const foodCount = 1 + (Math.random() < 0.6 ? 1 : 0);
        for (let f = 0; f < foodCount; f++) {
          const base = pick(foodsBase);
          state.foods.push({
            x: b.x + rand(10, b.w - 10),
            y: b.y + rand(10, b.h - 10),
            r: 9,
            kind: base.kind,
            value: Math.round(base.value * lvl.foodMult),
            color: base.color
          });
        }
      }

      const humanCount = 4 + state.level * 3;
      const types = ['kid', 'dad', 'lifeguard'];
      for (let i = 0; i < humanCount; i++) {
        const t = types[(i + state.level) % types.length];
        const isKid = t === 'kid';
        const isDad = t === 'dad';
        const isLife = t === 'lifeguard';
        state.humans.push({
          type: t,
          x: rand(90, W - 90),
          y: rand(90, H - 90),
          vx: rand(-1, 1),
          vy: rand(-1, 1),
          speed: (isKid ? 70 : isDad ? 100 : 86) * lvl.humanMult,
          range: (isKid ? 90 : isDad ? 130 : 170) * lvl.humanMult,
          stunned: 0,
          cooldown: 0
        });
      }

      state.seagull.x = W * 0.2;
      state.seagull.y = H * 0.5;
    }

    function startGame() {
      state.running = true;
      state.level = 0;
      state.score = 0;
      state.lives = 3;
      state.timer = 60;
      state.screamCd = 0;
      state.invuln = 0;
      createLevel();
      panel.innerHTML = '<h1>üê¶ Seagull Simulator</h1><p class="small">MINE! MINE! MINE!</p>';
      overlay.classList.add('hidden');
      setStatus('Beach is open. Commit crimes.');
      updateHud();
    }

    function updateHud() {
      uiLives.textContent = '‚ù§Ô∏è'.repeat(state.lives) + 'üñ§'.repeat(Math.max(0, 3 - state.lives));
      uiScore.textContent = `Score: ${state.score}`;
      uiLevel.textContent = `Level: ${state.level + 1} ‚Äî ${levels[state.level].name}`;
      uiTimer.textContent = `‚è± ${Math.ceil(state.timer)}`;
      coolFill.style.width = `${Math.max(0, Math.min(100, (state.screamCd / 3) * 100))}%`;
    }

    function moveSeagull(dt) {
      const s = state.seagull;
      let dx = 0, dy = 0;
      if (state.keys['ArrowLeft'] || state.keys['a']) dx -= 1;
      if (state.keys['ArrowRight'] || state.keys['d']) dx += 1;
      if (state.keys['ArrowUp'] || state.keys['w']) dy -= 1;
      if (state.keys['ArrowDown'] || state.keys['s']) dy += 1;

      if (state.pointer) {
        const px = state.pointer.x - s.x;
        const py = state.pointer.y - s.y;
        const d = Math.hypot(px, py);
        if (d > 8) {
          dx = px / d;
          dy = py / d;
        }
      }

      const m = Math.hypot(dx, dy) || 1;
      s.vx = (dx / m) * s.speed;
      s.vy = (dy / m) * s.speed;

      s.x += s.vx * dt;
      s.y += s.vy * dt;
      s.x = Math.max(12, Math.min(W - 12, s.x));
      s.y = Math.max(12, Math.min(H - 12, s.y));
    }

    function useScream() {
      if (state.screamCd > 0 || !state.running) return;
      state.screamCd = 3;
      state.shake = 0.25;
      setStatus('MINE! MINE! MINE!');
      sound('flap');

      const s = state.seagull;
      for (const h of state.humans) {
        const d = Math.hypot(h.x - s.x, h.y - s.y);
        if (d < 120) h.stunned = 1.5;
      }
    }

    function grabFood() {
      if (!state.running) return;
      const s = state.seagull;
      let best = -1;
      let bestD = 99999;
      for (let i = 0; i < state.foods.length; i++) {
        const f = state.foods[i];
        const d = Math.hypot(f.x - s.x, f.y - s.y);
        if (d < 28 && d < bestD) { best = i; bestD = d; }
      }
      if (best >= 0) {
        const f = state.foods.splice(best, 1)[0];
        state.score += f.value;
        state.floating.push({ x: s.x, y: s.y - 8, text: `+${f.value}`, t: 0.7, color: '#0d8a34' });
        setStatus(pick(['NOOO MY FRIES!', 'HEY! THAT WAS MINE!', 'SEAGULL CRIME IN PROGRESS!']));
        sound('grab');

        if (state.score % 100 === 0) sound('milestone');
      }
    }

    function hitSeagull(reason = 'Oof.') {
      if (state.invuln > 0) return;
      state.lives -= 1;
      state.invuln = 1.2;
      state.floating.push({ x: state.seagull.x, y: state.seagull.y - 10, text: '-1 ‚ù§Ô∏è', t: 0.8, color: '#c1121f' });
      setStatus(reason);
      sound('hit');
      if (state.lives <= 0) gameOver();
    }

    function updateHumans(dt) {
      const s = state.seagull;
      for (const h of state.humans) {
        if (h.stunned > 0) {
          h.stunned -= dt;
          h.cooldown -= dt;
          continue;
        }

        const dx = s.x - h.x;
        const dy = s.y - h.y;
        const d = Math.hypot(dx, dy) || 1;

        if (d < h.range) {
          h.vx = dx / d;
          h.vy = dy / d;

          if (h.type === 'dad' && h.cooldown <= 0 && d < 180) {
            h.cooldown = 2.4;
            state.projectiles.push({ x: h.x, y: h.y, vx: (dx / d) * 220, vy: (dy / d) * 220, t: 2.1 });
          }

          if (h.type === 'lifeguard' && h.cooldown <= 0 && d < 150) {
            h.cooldown = 3.2;
            state.seagull.speed = 140;
            setTimeout(() => { state.seagull.speed = 220; }, 900);
            state.floating.push({ x: s.x, y: s.y - 12, text: 'WHISTLE STUN!', t: 0.7, color: '#264653' });
          }
        } else {
          if (Math.random() < 0.02) {
            h.vx = rand(-1, 1);
            h.vy = rand(-1, 1);
          }
        }

        const m = Math.hypot(h.vx, h.vy) || 1;
        h.x += (h.vx / m) * h.speed * dt;
        h.y += (h.vy / m) * h.speed * dt;
        h.x = Math.max(14, Math.min(W - 14, h.x));
        h.y = Math.max(14, Math.min(H - 14, h.y));

        h.cooldown -= dt;

        if (Math.hypot(h.x - s.x, h.y - s.y) < 20) {
          hitSeagull('Caught by angry human!');
        }
      }
    }

    function updateProjectiles(dt) {
      for (let i = state.projectiles.length - 1; i >= 0; i--) {
        const p = state.projectiles[i];
        p.x += p.vx * dt;
        p.y += p.vy * dt;
        p.t -= dt;
        if (Math.hypot(p.x - state.seagull.x, p.y - state.seagull.y) < 14) {
          hitSeagull('Flip flop to the face.');
          state.projectiles.splice(i, 1);
          continue;
        }
        if (p.t <= 0 || p.x < -20 || p.y < -20 || p.x > W + 20 || p.y > H + 20) state.projectiles.splice(i, 1);
      }
    }

    function updateFloating(dt) {
      for (let i = state.floating.length - 1; i >= 0; i--) {
        const f = state.floating[i];
        f.t -= dt;
        f.y -= 24 * dt;
        if (f.t <= 0) state.floating.splice(i, 1);
      }
    }

    function checkProgress() {
      const target = levels[state.level].threshold;
      if (state.score >= target) {
        if (state.level < levels.length - 1) {
          state.level++;
          state.timer = 60;
          createLevel();
          state.floating.push({ x: W / 2, y: 60, text: `LEVEL ${state.level + 1}!`, t: 1.4, color: '#264653' });
          setStatus(`Welcome to ${levels[state.level].name}. It's worse.`);
        } else {
          gameOver(true);
        }
      }

      if (state.foods.length < 8) {
        // trickle spawns
        const b = pick(state.blankets);
        const base = pick(foodsBase);
        const lvl = levels[state.level];
        state.foods.push({ x: b.x + rand(8, b.w - 8), y: b.y + rand(8, b.h - 8), r: 9, kind: base.kind, value: Math.round(base.value * lvl.foodMult), color: base.color });
      }
    }

    async function gameOver(win = false) {
      state.running = false;
      overlay.classList.remove('hidden');
      const scoresRaw = await storageGet('seagull:scores');
      const scores = scoresRaw ? JSON.parse(scoresRaw) : [];
      const name = prompt('Name for leaderboard?', 'Anonymous Seagull') || 'Anonymous Seagull';
      scores.push({ name, score: state.score, date: Date.now() });
      scores.sort((a, b) => b.score - a.score);
      const top = scores.slice(0, 20);
      await storageSet('seagull:scores', JSON.stringify(top));
      await storageSet('seagull:leaderboard', JSON.stringify(top), true);
      state.leaderboard = top;
      renderLeaderboardText();

      const shareText = encodeURIComponent(`I stole ${state.score} points worth of beach food in Seagull Simulator üê¶`);
      panel.innerHTML = `
        <h1>${win ? 'üèÜ KING OF THE BOARDWALK' : 'üí• GAME OVER'}</h1>
        <p class="small">Final Score: <b>${state.score}</b></p>
        <p class="small">${win ? 'You terrorized every level.' : 'The humans defended their snacks.'}</p>
        <p class="small">Top 3: ${(top.slice(0, 3).map((s, i) => `#${i + 1} ${s.name} (${s.score})`).join(' ‚Ä¢ ') || 'none')}</p>
        <button id="playAgain">Play Again</button>
        <div style="margin-top:8px"><a href="https://twitter.com/intent/tweet?text=${shareText}" target="_blank">Share Score</a></div>
      `;
      document.getElementById('playAgain').onclick = () => startGame();
    }

    function drawBeach() {
      ctx.fillStyle = '#63c6ff';
      ctx.fillRect(0, 0, W, H * 0.24);
      ctx.fillStyle = '#f5d17a';
      ctx.fillRect(0, H * 0.24, W, H);

      for (const b of state.blankets) {
        ctx.fillStyle = b.color;
        ctx.fillRect(b.x, b.y, b.w, b.h);
      }
    }

    function drawFood(f) {
      ctx.save();
      ctx.translate(f.x, f.y);
      if (f.kind === 'fries') {
        ctx.fillStyle = '#ef4444';
        ctx.fillRect(-8, -4, 16, 10);
        ctx.fillStyle = '#fde047';
        for (let i = -6; i <= 4; i += 4) ctx.fillRect(i, -10, 3, 6);
      } else if (f.kind === 'hotdog') {
        ctx.fillStyle = '#fbbf24';
        ctx.fillRect(-10, -4, 20, 8);
        ctx.fillStyle = '#b45309';
        ctx.fillRect(-7, -2, 14, 4);
      } else if (f.kind === 'icecream') {
        ctx.fillStyle = '#d97706';
        ctx.beginPath(); ctx.moveTo(0, 8); ctx.lineTo(-6, -1); ctx.lineTo(6, -1); ctx.closePath(); ctx.fill();
        ctx.fillStyle = '#fef3c7';
        ctx.beginPath(); ctx.arc(0, -6, 6, 0, Math.PI * 2); ctx.fill();
      } else {
        ctx.fillStyle = '#f59e0b';
        ctx.beginPath(); ctx.moveTo(-10, 7); ctx.lineTo(10, 0); ctx.lineTo(-8, -8); ctx.closePath(); ctx.fill();
      }
      ctx.restore();
    }

    function drawSeagull() {
      const s = state.seagull;
      const ang = Math.atan2(s.vy, s.vx || 0.0001);
      ctx.save();
      ctx.translate(s.x, s.y);
      ctx.rotate(ang);
      if (state.invuln > 0 && (Date.now() / 80 | 0) % 2 === 0) ctx.globalAlpha = 0.4;
      ctx.fillStyle = '#ffffff';
      ctx.beginPath();
      ctx.moveTo(14, 0);
      ctx.lineTo(-12, -8);
      ctx.lineTo(-6, 0);
      ctx.lineTo(-12, 8);
      ctx.closePath();
      ctx.fill();
      ctx.fillStyle = '#fb923c';
      ctx.beginPath(); ctx.moveTo(14, 0); ctx.lineTo(21, 2); ctx.lineTo(14, 5); ctx.closePath(); ctx.fill();
      ctx.restore();
    }

    function drawHuman(h) {
      ctx.save();
      ctx.translate(h.x, h.y);
      if (h.stunned > 0) ctx.globalAlpha = 0.45;
      ctx.fillStyle = h.type === 'kid' ? '#3b82f6' : h.type === 'dad' ? '#ef4444' : '#10b981';
      ctx.beginPath(); ctx.arc(0, 0, 11, 0, Math.PI * 2); ctx.fill();
      ctx.fillStyle = '#fff';
      ctx.font = '10px system-ui';
      ctx.textAlign = 'center';
      ctx.fillText(h.type === 'kid' ? 'üë¶' : h.type === 'dad' ? 'üë®' : 'üèñÔ∏è', 0, 4);
      ctx.restore();
    }

    function drawProjectile(p) {
      ctx.fillStyle = '#6b7280';
      ctx.beginPath();
      ctx.ellipse(p.x, p.y, 8, 4, Math.atan2(p.vy, p.vx), 0, Math.PI * 2);
      ctx.fill();
    }

    function drawFloating() {
      for (const f of state.floating) {
        ctx.fillStyle = f.color;
        ctx.globalAlpha = Math.max(0, Math.min(1, f.t / 0.7));
        ctx.font = 'bold 18px system-ui';
        ctx.fillText(f.text, f.x, f.y);
      }
      ctx.globalAlpha = 1;
    }

    let last = performance.now();
    function frame(now) {
      const dt = Math.min(0.033, (now - last) / 1000);
      last = now;

      if (state.running) {
        state.timer -= dt;
        state.screamCd = Math.max(0, state.screamCd - dt);
        state.invuln = Math.max(0, state.invuln - dt);
        state.shake = Math.max(0, state.shake - dt);

        moveSeagull(dt);
        updateHumans(dt);
        updateProjectiles(dt);
        updateFloating(dt);
        checkProgress();

        if (state.timer <= 0) {
          if (state.score >= levels[state.level].threshold) {
            if (state.level < levels.length - 1) {
              state.level++;
              state.timer = 60;
              createLevel();
            } else {
              gameOver(true);
            }
          } else {
            gameOver(false);
          }
        }
      }

      updateHud();

      const sx = state.shake > 0 ? rand(-5, 5) : 0;
      const sy = state.shake > 0 ? rand(-5, 5) : 0;
      ctx.save();
      ctx.translate(sx, sy);

      drawBeach();
      for (const f of state.foods) drawFood(f);
      for (const h of state.humans) drawHuman(h);
      for (const p of state.projectiles) drawProjectile(p);
      drawSeagull();
      drawFloating();

      ctx.restore();
      requestAnimationFrame(frame);
    }

    // input
    window.addEventListener('keydown', (e) => {
      state.keys[e.key] = true;
      if (e.key === ' ' || e.code === 'Space') { e.preventDefault(); useScream(); }
      if (e.key.toLowerCase() === 'e') grabFood();
    }, { passive: false });
    window.addEventListener('keyup', (e) => { state.keys[e.key] = false; });

    cvs.addEventListener('pointerdown', (e) => {
      const r = cvs.getBoundingClientRect();
      const x = (e.clientX - r.left) * (W / r.width);
      const y = (e.clientY - r.top) * (H / r.height);
      state.pointer = { x, y };
    });
    cvs.addEventListener('pointermove', (e) => {
      if (!state.pointer) return;
      const r = cvs.getBoundingClientRect();
      state.pointer.x = (e.clientX - r.left) * (W / r.width);
      state.pointer.y = (e.clientY - r.top) * (H / r.height);
    });
    window.addEventListener('pointerup', () => { state.pointer = null; });

    screamBtn.addEventListener('click', useScream);
    grabBtn.addEventListener('click', grabFood);
    playAgainBtn.addEventListener('click', startGame);

    // tap food to grab on mobile
    cvs.addEventListener('click', (e) => {
      const r = cvs.getBoundingClientRect();
      const x = (e.clientX - r.left) * (W / r.width);
      const y = (e.clientY - r.top) * (H / r.height);
      for (const f of state.foods) {
        if (Math.hypot(f.x - x, f.y - y) < 20) {
          grabFood();
          break;
        }
      }
    });

    loadLeaderboard();
    requestAnimationFrame(frame);
  </script>
</body>
</html>